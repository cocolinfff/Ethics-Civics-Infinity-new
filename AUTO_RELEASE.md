# 自动发布工作流说明

## 功能概述

此 GitHub Actions 工作流实现了以下功能：

1. 每月1号自动运行检查
2. 检查仓库是否有新的提交
3. 如果有更新，则自动生成 Release 和更新日志
4. 可以使用 LLM API（如 DeepSeek）生成更智能的更新公告

## 工作流详情

- **触发条件**：
  - 每月1号 UTC 时间 0 点自动运行
  - 可以通过 GitHub 界面手动触发

- **工作流程**：
  1. 检查代码仓库中的最新提交
  2. 与上一个 Release 版本进行比较
  3. 如果有新的提交，则生成更新日志
  4. 调用 LLM API 优化更新公告（可选）
  5. 创建新的 Release

## 权限配置

已在工作流中添加了必要的权限声明：

```yaml
permissions:
  contents: write  # 授予创建release的权限
```

这个配置解决了 "Resource not accessible by integration" 错误，确保工作流有足够的权限创建 release。

## 安全配置：LLM API密钥管理

为了确保API密钥的安全性，工作流采用了GitHub Secrets机制来存储和使用密钥。这种方式确保了密钥：

1. 不会出现在代码中
2. 不会被提交到版本控制系统
3. 在工作流运行时安全地注入

### 配置步骤：

1. 转到仓库的 Settings
2. 点击左侧菜单中的 "Secrets and variables" → "Actions"
3. 点击 "New repository secret" 按钮
4. 添加以下信息：
   - Name: `DEEPSEEK_API_KEY`
   - Value: 你的 DeepSeek API 密钥
5. 点击 "Add secret" 完成配置

### 在工作流中的使用方式：

工作流通过以下方式安全地使用密钥：

```yaml
env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
```

这确保了密钥在运行时被安全注入，而不会暴露在代码或日志中。

### 安全优势：

- 密钥在GitHub界面中被加密存储
- 密钥不会出现在工作流的YAML文件中
- 密钥不会出现在GitHub Actions的日志中
- 只有授权的仓库协作者可以管理密钥
- 可以随时更新或删除密钥而不影响代码

## 智能更新日志生成

增强的LLM功能现在不仅基于提交历史，还结合了实际变更的文件列表来生成更准确的更新日志。

### 提供的信息包括：

1. **提交历史**：所有相关的git提交信息
2. **文件变更列表**：实际修改、添加或删除的文件
3. **超时处理**：为LLM调用设置30秒超时，防止长时间等待

### 使用的模型：

- **模型名称**：deepseek-reasoner
- **API端点**：https://api.deepseek.com/v1

### 生成格式：

LLM会按照以下格式生成更新日志：
```
## 更新日志

### 主要变更
[列出主要功能更新]

### 优化改进
[列出优化和改进]

### 问题修复
[列出修复的问题]
```

### 容错机制：

- 如果LLM调用超时或失败，会自动回退到默认更新日志
- 如果没有配置API密钥，也会使用默认更新日志
- 文件列表限制在前50个文件，防止信息过载

## 配置说明

### 基础配置（必需）

工作流会自动运行，无需额外配置。

### 高级配置（可选）

要启用 LLM 自动生成更新公告功能，需要按上述步骤配置API密钥。

支持的 LLM API:
- DeepSeek Reasoner 模型
- 其他兼容 OpenAI API 格式的模型

## 版本号规则

版本号格式为 `YYYY.MM.N`：
- YYYY: 当前年份
- MM: 当前月份
- N: 修订号（默认为1）

例如：`2025.07.1` 表示 2025 年 7 月的第一次发布。

## 故障处理

如果自动发布失败，可以通过以下方式处理：

1. 检查 GitHub Actions 日志找出错误原因
2. 修复问题后可以手动重新运行工作流
3. 或者手动创建 Release

## 注意事项

1. 工作流使用 UTC 时间，可能与本地时间有差异
2. 如果一个月内多次更新，只会发布一个月度 Release
3. 首次运行时，由于没有历史 Release，会基于所有历史提交生成更新日志
4. 如果没有配置API密钥，工作流会使用默认的更新日志生成方式
5. LLM调用设置了30秒超时，防止长时间等待影响发布流程