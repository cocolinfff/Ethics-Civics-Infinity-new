name: ğŸ› ï¸ æ‰‹åŠ¨è§¦å‘ - Mod å®Œæ•´æ€§æ£€æµ‹

# workflow_dispatch æ˜¯å®ç°"ä»…æ‰‹åŠ¨è¿è¡Œ"çš„æ ¸å¿ƒ
on:
  workflow_dispatch:
    inputs:
      log_level:
        description: 'æ£€æµ‹ä¸¥æ ¼ç¨‹åº¦ (è¾“å‡ºæ—¥å¿—çº§åˆ«)'
        required: true
        default: 'WARNING'
        type: choice
        options:
          - INFO
          - WARNING
          - ERROR
          - DEBUG

jobs:
  mod-linter:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºå½“å‰ Mod çš„ä»£ç 
      - name: ğŸ“¦ æ£€å‡º Mod æºç 
        uses: actions/checkout@v4

      # 2. æ£€å‡ºæ£€æµ‹å·¥å…·ä»£ç  (ä» stellaris_cwt_linter ä»“åº“)
      - name: ğŸ“¥ æ£€å‡ºæ£€æµ‹å·¥å…·ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: cocolinfff/stellaris_cwt_linter
          path: ./linter_tool
          ref: master

      # 3. é…ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. è¿è¡Œæ£€æµ‹å·¥å…·å¹¶æ•è·è¾“å‡º
      - name: ğŸš€ è¿è¡Œå®Œæ•´æ€§æ£€æµ‹
        id: run_linter
        run: |
          echo "å¼€å§‹è¿è¡Œæ£€æµ‹å·¥å…·..."
          echo "å½“å‰ç›®å½•: $(pwd)"
          # å½“å‰ç›®å½•å°±æ˜¯ Mod ç›®å½•ï¼Œå·¥å…·åœ¨ ./linter_tool å­ç›®å½•
          # è¿è¡Œå·¥å…·ï¼Œä¼ å…¥å½“å‰ç›®å½• (.) ä½œä¸º mod è·¯å¾„
          cd linter_tool && python main.py .. > ../linter_report.txt 2>&1 || true
          cd ..
          if [ -f linter_report.txt ]; then
            echo "æŠ¥å‘Šå·²ç”Ÿæˆ"
            ls -la linter_report.txt
            echo "æŠ¥å‘Šå†…å®¹å‰10è¡Œ:"
            head -10 linter_report.txt
            # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if grep -qiE "^(Error|Exception|Traceback|Fatal|Critical)" linter_report.txt; then
              echo "LINTER_FAILED=true" >> $GITHUB_ENV
            fi
          else
            echo "æŠ¥å‘Šæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            echo "LINTER_FAILED=true" >> $GITHUB_ENV
          fi

      # 5. è¾“å‡ºå®Œæ•´æŠ¥å‘Šå†…å®¹
      - name: ğŸ“„ è¾“å‡ºå®Œæ•´æŠ¥å‘Š
        run: |
          if [ -f linter_report.txt ]; then
            echo "## ğŸ“„ å®Œæ•´æ£€æµ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```text' >> $GITHUB_STEP_SUMMARY
            cat linter_report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "æŠ¥å‘Šæ–‡ä»¶ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

      # 6. æä¾›å®Œæ•´æ—¥å¿—æ–‡ä»¶ä¾›ä¸‹è½½
      - name: ğŸ’¾ ä¸Šä¼ å®Œæ•´æ—¥å¿—é™„ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: Mod-Linter-Report-${{ github.ref_name }}
          path: linter_report.txt
          retention-days: 7

      # 7. å¦‚æœä¸Šä¸€æ­¥æ£€æµ‹å‡ºè‡´å‘½é”™è¯¯ï¼Œåœ¨è¿™é‡Œè®© Action æ ‡çº¢å˜è´¥
      - name: ğŸ›‘ åˆ¤å®šæœ€ç»ˆçŠ¶æ€
        if: env.LINTER_FAILED == 'true'
        run: |
          echo "::error::æ£€æµ‹åˆ°è‡´å‘½é”™è¯¯æˆ–æ–­é“¾ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æŠ¥å‘Šï¼"
          exit 0
