name: ğŸ› ï¸ æ‰‹åŠ¨è§¦å‘ - Mod å®Œæ•´æ€§æ£€æµ‹

# workflow_dispatch æ˜¯å®ç°"ä»…æ‰‹åŠ¨è¿è¡Œ"çš„æ ¸å¿ƒ
on:
  workflow_dispatch:
    inputs:
      log_level:
        description: 'æ£€æµ‹ä¸¥æ ¼ç¨‹åº¦ (è¾“å‡ºæ—¥å¿—çº§åˆ«)'
        required: true
        default: 'WARNING'
        type: choice
        options:
          - INFO
          - WARNING
          - ERROR
          - DEBUG

jobs:
  mod-linter:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºå½“å‰ Mod çš„ä»£ç 
      - name: ğŸ“¦ æ£€å‡º Mod æºç 
        uses: actions/checkout@v4

      # 2. æ£€å‡ºæ£€æµ‹å·¥å…·ä»£ç  (ä» stellaris_cwt_linter ä»“åº“)
      - name: ğŸ“¥ æ£€å‡ºæ£€æµ‹å·¥å…·ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: cocolinfff/stellaris_cwt_linter
          path: ./linter_tool
          ref: main

      # 3. é…ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 4. è¿è¡Œæ£€æµ‹å·¥å…·å¹¶æ•è·è¾“å‡º
      - name: ğŸš€ è¿è¡Œå®Œæ•´æ€§æ£€æµ‹
        id: run_linter
        run: |
          echo "å¼€å§‹è¿è¡Œæ£€æµ‹å·¥å…·..."
          # è¿›å…¥å·¥å…·ç›®å½•å¹¶è¿è¡Œæ£€æµ‹
          cd linter_tool
          python main.py ../ > ../linter_report.txt 2>&1 || echo "LINTER_FAILED=true" >> $GITHUB_ENV

      # 5. é«˜å®Œæˆåº¦æ ¸å¿ƒï¼šç”Ÿæˆ GitHub ç½‘é¡µç«¯å¯è§†åŒ–æŠ¥å‘Š
      - name: ğŸ“Š ç”Ÿæˆç½‘é¡µæ£€æµ‹æŠ¥å‘Š
        run: |
          # ç»Ÿè®¡é”™è¯¯ã€è­¦å‘Šã€ä¿¡æ¯æ•°é‡
          ERRORS=$(grep -c "ERROR" linter_report.txt 2>/dev/null || echo "0")
          WARNINGS=$(grep -c "WARNING" linter_report.txt 2>/dev/null || echo "0")
          INFOS=$(grep -c "INFO" linter_report.txt 2>/dev/null || echo "0")

          echo "## ğŸ” Mod å®Œæ•´æ€§æ£€æµ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | æ•°å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|:---:|:---:|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ·ï¸ è¿è¡Œåˆ†æ”¯ | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ æ£€æµ‹çº§åˆ« | \`${{ inputs.log_level }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ é”™è¯¯ | **$ERRORS** |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ è­¦å‘Š | **$WARNINGS** |" >> $GITHUB_STEP_SUMMARY
          echo "| â„¹ï¸ æç¤º | **$INFOS** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # è¯»å–æŠ¥å‘Šæ–‡ä»¶
          if [ -f linter_report.txt ]; then
            # æå–è§„åˆ™ä¿¡æ¯
            echo "### ğŸ“‹ è§„åˆ™ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "^Stellaris Version:|^Game Path:|^Rules Built:|^Threshold:" linter_report.txt | head -5 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # å®ä½“ç»Ÿè®¡
            echo "### ğŸ“Š å®ä½“ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "^Files:|^Total entities:|^  \+ " linter_report.txt | head -10 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # é”™è¯¯è¯¦æƒ…
            if [ "$ERRORS" -gt "0" ]; then
              echo "### âŒ é”™è¯¯è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A1 "ERROR\]" linter_report.txt | head -20 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # è­¦å‘Šè¯¦æƒ…
            if [ "$WARNINGS" -gt "0" ]; then
              echo "### âš ï¸ è­¦å‘Šè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep "WARNING\]" linter_report.txt | head -15 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # ç¼ºå¤±æ¨èå­—æ®µç»Ÿè®¡
            echo "### ğŸ“ ç¼ºå¤±æ¨èå­—æ®µ (éƒ¨åˆ†)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep "Missing recommended" linter_report.txt | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      # 6. æä¾›å®Œæ•´æ—¥å¿—æ–‡ä»¶ä¾›ä¸‹è½½
      - name: ğŸ’¾ ä¸Šä¼ å®Œæ•´æ—¥å¿—é™„ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: Mod-Linter-Report-${{ github.ref_name }}
          path: linter_report.txt
          retention-days: 7

      # 7. å¦‚æœä¸Šä¸€æ­¥æ£€æµ‹å‡ºè‡´å‘½é”™è¯¯ï¼Œåœ¨è¿™é‡Œè®© Action æ ‡çº¢å˜è´¥
      - name: ğŸ›‘ åˆ¤å®šæœ€ç»ˆçŠ¶æ€
        if: env.LINTER_FAILED == 'true'
        run: |
          echo "::error::æ£€æµ‹åˆ°è‡´å‘½é”™è¯¯æˆ–æ–­é“¾ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æŠ¥å‘Šï¼"
          exit 1
