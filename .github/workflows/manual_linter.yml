name: ğŸ› ï¸ æ‰‹åŠ¨è§¦å‘ - Mod å®Œæ•´æ€§æ£€æµ‹

# workflow_dispatch æ˜¯å®ç°"ä»…æ‰‹åŠ¨è¿è¡Œ"çš„æ ¸å¿ƒ
on:
  workflow_dispatch:
    inputs:
      log_level:
        description: 'æ£€æµ‹ä¸¥æ ¼ç¨‹åº¦ (è¾“å‡ºæ—¥å¿—çº§åˆ«)'
        required: true
        default: 'WARNING'
        type: choice
        options:
          - INFO
          - WARNING
          - ERROR
          - DEBUG

jobs:
  mod-linter:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºå½“å‰ Mod çš„ä»£ç 
      - name: ğŸ“¦ æ£€å‡º Mod æºç 
        uses: actions/checkout@v4

      # 2. æ£€å‡ºæ£€æµ‹å·¥å…·ä»£ç  (ä» stellaris_cwt_linter ä»“åº“)
      - name: ğŸ“¥ æ£€å‡ºæ£€æµ‹å·¥å…·ä»£ç 
        uses: actions/checkout@v4
        with:
          repository: cocolinfff/stellaris_cwt_linter
          path: ./linter_tool
          ref: master

      # 3. é…ç½® Python ç¯å¢ƒ
      - name: ğŸ è®¾ç½® Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. è¿è¡Œæ£€æµ‹å·¥å…·å¹¶æ•è·è¾“å‡º
      - name: ğŸš€ è¿è¡Œå®Œæ•´æ€§æ£€æµ‹
        id: run_linter
        run: |
          echo "å¼€å§‹è¿è¡Œæ£€æµ‹å·¥å…·..."
          echo "å½“å‰ç›®å½•: $(pwd)"
          # å½“å‰ç›®å½•å°±æ˜¯ Mod ç›®å½•ï¼Œå·¥å…·åœ¨ ./linter_tool å­ç›®å½•
          # è¿è¡Œå·¥å…·ï¼Œä¼ å…¥å½“å‰ç›®å½• (..) ä½œä¸º mod è·¯å¾„
          # ä½¿ç”¨å­shellç¡®ä¿å·¥ä½œç›®å½•è‡ªåŠ¨æ¢å¤
          if [ -d linter_tool ]; then
            # è¿è¡Œå·¥å…·å¹¶æ•è·æ§åˆ¶å°è¾“å‡º
            (cd linter_tool && python main.py .. 2>&1) | tee console_output.txt || true
            
            # æŸ¥æ‰¾ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶ï¼ˆæ ¼å¼ï¼šmod_analysis_<æ¨¡ç»„å>_<æ—¶é—´æˆ³>.txtï¼‰
            REPORT_FILE=$(find linter_tool -maxdepth 1 -name "mod_analysis_*.txt" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2-)
            
            if [ -n "$REPORT_FILE" ] && [ -f "$REPORT_FILE" ]; then
              echo "æ‰¾åˆ°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶: $REPORT_FILE"
              # å¤åˆ¶æŠ¥å‘Šæ–‡ä»¶åˆ°æ ¹ç›®å½•
              cp "$REPORT_FILE" linter_report.txt
              echo "æŠ¥å‘Šæ–‡ä»¶å¤§å°:"
              ls -lh linter_report.txt
              echo "æŠ¥å‘Šå†…å®¹å‰20è¡Œ:"
              head -20 linter_report.txt
            else
              echo "æœªæ‰¾åˆ°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶ï¼Œä½¿ç”¨æ§åˆ¶å°è¾“å‡ºä½œä¸ºæŠ¥å‘Š"
              mv console_output.txt linter_report.txt
            fi
            
            # æ£€æŸ¥å·¥å…·æ˜¯å¦å´©æºƒ (æ£€æµ‹ Python Traceback æ ‡è¯†)
            if grep -q "^Traceback" linter_report.txt; then
              echo "LINTER_FAILED=true" >> $GITHUB_ENV
            fi
          else
            echo "é”™è¯¯: linter_tool ç›®å½•ä¸å­˜åœ¨"
            echo "LINTER_FAILED=true" >> $GITHUB_ENV
            exit 1
          fi
          
          if [ ! -f linter_report.txt ]; then
            echo "æŠ¥å‘Šæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            echo "LINTER_FAILED=true" >> $GITHUB_ENV
          fi

      # 5. è¾“å‡ºå®Œæ•´æŠ¥å‘Šå†…å®¹
      - name: ğŸ“„ è¾“å‡ºå®Œæ•´æŠ¥å‘Š
        run: |
          if [ -f linter_report.txt ]; then
            echo "## ğŸ“„ å®Œæ•´æ£€æµ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```text' >> $GITHUB_STEP_SUMMARY
            cat linter_report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "æŠ¥å‘Šæ–‡ä»¶ç”Ÿæˆå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

      # 6. æä¾›å®Œæ•´æ—¥å¿—æ–‡ä»¶ä¾›ä¸‹è½½
      - name: ğŸ’¾ ä¸Šä¼ å®Œæ•´æ—¥å¿—é™„ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: Mod-Linter-Report-${{ github.ref_name }}
          path: linter_report.txt
          retention-days: 7

      # 7. å¦‚æœä¸Šä¸€æ­¥æ£€æµ‹å‡ºè‡´å‘½é”™è¯¯ï¼Œåœ¨è¿™é‡Œè®© Action æ ‡çº¢å˜è´¥
      - name: ğŸ›‘ åˆ¤å®šæœ€ç»ˆçŠ¶æ€
        if: env.LINTER_FAILED == 'true'
        run: |
          echo "::error::æ£€æµ‹åˆ°è‡´å‘½é”™è¯¯æˆ–æ–­é“¾ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æŠ¥å‘Šï¼"
          exit 0
